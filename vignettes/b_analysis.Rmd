---
title: "Analyzing Iowa Liquor Sales"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyzing Iowa Liquor Sales}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.height = 5,
  fig_width = 8,
  warning = FALSE
)
```

The {ialiquor} package provides a monthly summary Class E liquor sales in the state of Iowa by county or category between January 2015 and October 2020. This document is designed to demonstrate some potential use cases/analyses.

## Dataset Preview

Let us quickly preview the main dataset. We will also store the dataset in a new variable called `liquor` for ease of use.

```{r setup}
library(ialiquor)

data("liquor_sales")

liquor <- liquor_sales
```

Let's preview the sales by county:

```{r preview_liquor}

dplyr::glimpse(liquor)

```

The `type` column is a derived column (not found on the original dataset) that is a higher level grouping column for more specific types (i.e., categories) of liquor. For instance, amaretto is considered to be a liqueur and bourbon/scotch is just whiskey. It is important to keep in mind that this variable (`type`) is arbitrary and defined by the package author.

## Exploratory Data Analysis

Luckily for us, all of variables in each of the datasets are coded correctly. Let's focus on answering some of the key questions:

- Retail Revenue by County
- Revenue per Person
- Profit by Type of Liquor
- 2019 Profit by Type Breakdown
- 2019 Top Categories
- Proportion of Costs by Type

### Top Retail Revenue Counties Each Year


```{r usecase-1}

library(dplyr)
library(ggplot2)

liquor %>%
  group_by(year, county) %>%
  summarize(
    total_revenue = sum(state_revenue),
    .groups = 'drop'
  ) %>%
  ungroup() %>%
  group_by(year) %>%
  slice(which.max(total_revenue))

```

It's interesting to note that Polk county had the most revenue. Why is that? Let's take a look at the top county for each year in terms of population

```{r}
liquor %>%
  group_by(year, county) %>%
  summarize(
    population = max(population),
    .groups = 'drop'
  ) %>%
  ungroup() %>%
  group_by(year) %>%
  slice(which.max(population))
```

Seems as if Polk County is the largest county and it may be intuitive to assume that there are more persons buying liquor in this county.

So let's look at revenue per person (based on population of the year), will we see different results?

```{r}
liquor %>%
  mutate(
    rev_per_person = round(state_revenue / population , 2)
  ) %>%
  group_by(year, county) %>%
  summarize(
    rev_per_person = round(sum(rev_per_person),2),
    .groups = 'drop'
  ) %>%
  ungroup() %>%
  group_by(year) %>%
  slice(which.max(rev_per_person))
  
```

Now this is interesting. Seems as if Dickinson county has the highest revenue per person. Keep in mind that the population values also represent individuals who are not of legal age to consume liquor (i.e., under the legal age of 21). Due to the large data size, this package does not contain the brand of liquor. However, this can easily be obtained via the Iowa Data Portal for further analysis.

### Top Types of Liquor by Profit to State

Perhaps it is interesting to look at the profit to the state by type of liquor over time. 

```{r, message=FALSE, warning = FALSE, fig.height=5, fig.width=8}

liquor %>%
  filter(!type %in% c('beer','other','unknown')) %>%
  mutate(
    profit = state_revenue - state_cost
  ) %>%
  group_by(year, type) %>%
  summarize(
    total_profit = sum(profit),
    .groups = 'drop'
  ) %>%
  plotly::plot_ly(
    x = ~year,
    y = ~total_profit,
    color = ~type,
    type = 'scatter',
    mode = 'lines'
  ) %>%
  plotly::layout(
    title = "Annual Profit from Class E Liquor Sales by Liquor Type",
    yaxis = list(title = "Profit in US$"),
    xaxis = list(title = "Year"),
    annotations = list(x = 1.2, y = -0.1,
                       text = "Source: Iowa Data Portal",
                       showarrow = F, xref = 'paper', yref = 'paper',
                       font = list(size = 10, color = 'darkblue'))
  )

```
From the chart above, we can see that whiskey, vodka, and rum account for quite a bit of profit for the state as compared to the other types of liquor. Anecdotally speaking, when I shop at my local liquor store, I do find many types of whiskeys. However, I'm surprised to see rum in the top three as I don't see as many rum varieties as compared to tequila or liqueur.

### Top Profit Makers for 2019

Let's focus on 2019 and see which types of liquor accounted for the vast majority. For this, we'll make a pie chart. The conclusions may be similar to before, but in this case, we can see the impact of the different types for one year a bit more clearly.

```{r, fig.height=5, fig.width=8}

liquor %>%
  filter(!type %in% c('beer','other','unknown')) %>%
  mutate(
    profit = state_revenue - state_cost
  ) %>%
  filter(year == 2019) %>%
  group_by(type) %>%
  summarize(
    total_profit = sum(profit),
    .groups = 'drop'
  ) %>%
  plotly::plot_ly(
    labels = ~type,
    values = ~total_profit
  ) %>%
  plotly::add_pie(hole = 0.4) %>%
  plotly::layout(
  title = "2019 Profit Percentage by Liquor Type",
  annotations = list(x = 1.2, y = -0.1,
                     text = "Source: Iowa Data Portal",
                     showarrow = F, xref = 'paper', yref = 'paper',
                     font = list(size = 10, color = 'darkblue'))
  )

```

### Top Categories for 2019

While the `type` variable is derived by me (the package author), the `category` variable is determined by the State of Iowa. The following tree map illustrates the breakdown of the different categories that resulted in the highest profit to the state.

```{r, fig.height=5, fig.width=8}
liquor %>%
  filter(!type %in% c('beer','other','unknown')) %>%
  mutate(
    profit = state_revenue - state_cost
  ) %>%
  filter(year == 2019) %>%
  group_by(type, category) %>%
  summarize(
    total_profit = sum(profit),
    .groups = 'drop'
  ) %>%
  plotly::plot_ly(
    labels = ~category,
    values = ~total_profit,
    type = 'treemap',
    parents = NA,
    name = 'test',
    textinfo="label+value parent"
  ) %>%
  plotly::layout(
  title = "2019 Highest Profit Categories",
  annotations = list(x = 1, y = -0.1,
                     text = "Source: Iowa Data Portal",
                     showarrow = F, xref = 'paper', yref = 'paper',
                     font = list(size = 10, color = 'darkblue'))
  )
```

It is interesting to see that 'american vodka' and 'canadian whiskeys' contributed the most to the 2019 profit. While this dataset does not contain specific brands, we can tap into the API to find the brands associated with 'american vodka' or 'canadian whiskies'. Personally, I'm a fan of scotch (type of whiskey from Scotland) and it seems as if that type of whiskey is not very popular in Iowa!

### Proportion of Costs to State

Last but not least, let's take a look at the proportion of costs to the state. These are costs paid by the state to purchase the liquor from the appropriate vendors.

```{r, fig.height=5, fig.width=8}
liquor_sales %>%
  filter(!type %in% c('beer','other','unknown')) %>%
  group_by(year_month, type) %>%
  summarize(total_cost = sum(state_cost), .groups = 'drop') %>%
  tidyr::pivot_wider(
    names_from = type,
    values_from = total_cost
  ) %>%
  ungroup() %>%
  as.data.frame() %>%
  plotly::plot_ly(
    x = ~year_month,
    y = ~brandy,
    name = 'Brandy',
    type = 'scatter',
    mode = 'none',
    stackgroup = 'one',
    groupnorm = 'percent',
    fillcolor = 'magenta'
  ) %>%
  plotly::add_trace(
    y = ~cocktail,
    name = 'Cocktail',
    fillcolor = 'green'
  ) %>%
  plotly::add_trace(
    y = ~gin,
    name = 'Gin',
    fillcolor = 'skyblue'
  ) %>%
  plotly::add_trace(
    y = ~liqueur,
    name = 'Liqueur',
    fillcolor = 'orange'
  ) %>%
  plotly::add_trace(
    y = ~rum,
    name = 'rum',
    fillcolor = 'brown'
  ) %>%
  plotly::add_trace(
    y = ~schnapps,
    name = 'Schnapps',
    fillcolor = 'darkgreen'
  ) %>%
  plotly::add_trace(
    y = ~tequila,
    name = 'Tequila',
    fillcolor = 'gold'
  ) %>%
  plotly::add_trace(
    y = ~vodka,
    name = 'Vodka',
    fillcolor = 'cyan'
  ) %>%
  plotly::add_trace(
    y = ~whiskey,
    name = 'Whiskey',
    fillcolor = 'mustard'
  ) %>%
  plotly::layout(
    title = 'State Costs of Purchasing Liquor from Vendors',
    yaxis = list(
      title = 'Proportion of Cost (US$ - Not Adjusted for Inflation)', 
      showgrid = F, 
      ticksuffix = '%'),
    xaxis = list(
      title = 'Year/Month', 
      showgrid = F),
    annotations = list(x = 1.2, y = -0.1,
                     text = "Source: Iowa Data Portal",
                     showarrow = F, xref = 'paper', yref = 'paper',
                     font = list(size = 10, color = 'darkblue'))
  )
```

It is not suprising to see that whiskey, rum, and vodka continue to have the most cost. Much of this can be attributed to the quantity the state purchases.